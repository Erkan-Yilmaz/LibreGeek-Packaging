#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_HOST_ARCH_OS ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)
DEB_HOST_ARCH_BITS ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_BITS)
DEB_HOST_ARCH_CPU ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

export PATH := $(PATH):$(shell pwd)/src
export CFLAGS := $(shell dpkg-buildflags --get CFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)
export CXXFLAGS := $(shell dpkg-buildflags --get CXXFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)
export LDFLAGS := $(shell dpkg-buildflags --get LDFLAGS) -Wl,--as-needed

current_dir = $(shell pwd)

# Set versions for install files (not working in install file, research)
SO_VERSION = 5.7.0

# Modify web engine optoins

WEBENGINE_CONFIG = use_system_expat=1
WEBENGINE_CONFIG += use_system_flac=1
WEBENGINE_CONFIG += use_system_libevent=1
WEBENGINE_CONFIG += use_system_libjpeg=1
WEBENGINE_CONFIG += use_system_libpng=1
WEBENGINE_CONFIG += use_system_libusb=1
WEBENGINE_CONFIG += use_system_libxml=1
WEBENGINE_CONFIG += use_system_libxslt=1
WEBENGINE_CONFIG += use_system_opus=1
WEBENGINE_CONFIG += use_system_snappy=1
WEBENGINE_CONFIG += use_system_speex=1
WEBENGINE_CONFIG += use_system_harfbuzz=0
WEBENGINE_CONFIG += use_system_icu=1
WEBENGINE_CONFIG += use_system_libwebp=1
WEBENGINE_CONFIG += use_system_libvpx=1
WEBENGINE_CONFIG += use_system_openssl=1
WEBENGINE_CONFIG += use_system_re2=1
WEBENGINE_CONFIG += use_system_zlib=1
WEBENGINE_CONFIG += use_system_sqlite=0

%:
	dh $@
	
override_dh_auto_configure:
	# Replace var placeholders with multi-arch equiv. and so ver.
	find . -name *.install -print0 | xargs -0 sed -i "s|@DEB_HOST_MULTIARCH@|$(DEB_HOST_MULTIARCH)|g"
	find . -name *.install -print0 | xargs -0 sed -i "s|@SO_VERSION@|$(SO_VERSION)|g"
	# Trim .git dirs
	find . -name .git -print0 | xargs -0 rm -rf
	#force the configure script to generate the forwarding headers (it checks whether .git directory exists)
	mkdir .git
	# Modify gyp bulid (modeled after opensuse 5.6 spec. file)
	$(current_dir)/src/3rdparty/chromium/build/linux/unbundle/replace_gyp_files.py "$(myconf)"
	# configure
	qmake -r
